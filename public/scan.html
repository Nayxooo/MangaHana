<!DOCTYPE html>
<html lang="fr">
    <head>
        <title></title> 
        <meta charset="UTF-8">
        <meta name="description" content="MangaHana - Lecture de scans">
        <meta name="keywords" content="mangahana, scan, vf, sans pubs, free">
        <link rel="canonical" href="https://mangahana.fr/">
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        <link rel="shortcut icon" type="image/png" href="/img/mangahana-icon.png">
        <link rel="shortcut icon" sizes="192x192" href="/img/mangahana-icon.png">
        <link rel="apple-touch-icon" href="/img/mangahana-icon.png">
        <link rel="manifest" href="/manifest.json">
        <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
        <link rel="stylesheet" href="/styles/style.css">
        <link rel="stylesheet" href="/styles/navbar-footer.css">
        <link rel="stylesheet" href="/styles/style-scan.css">
        <link rel="stylesheet" href="/styles/resp-scan.css">
    </head>

    <body>
        <!-- Navbar -->
        <nav>

            <!-- Burger button -->
            <div class="burger-menu">
                <button class="burger-menu-btn">
                    <div class="burger-line"></div>
                    <div class="burger-line"></div>
                    <div class="burger-line"></div>
                </button>
            </div>

            <!-- Logo -->
            <a class="nav-img" href="/"><img src="/img/mangahana-logo.png" alt="MangaHana-logo"></a>
            
            <!-- Barre de recherche -->
            <div class="nav-searchbar">
                <div class="flexbox">
                    <i class='bx bx-search'></i>
                    <input name="search_text" id="search_text" type="search" class="search-input" placeholder="Rechercher..." autocomplete="off">
                    <button type="button" class="clear-button" id="clear-button">
                        <img src="/img/cursors/cross.avif" alt="Clear search" class="clear-icon">
                    </button>
                </div>
                <!-- Résultats de recherche -->
                <div id="search-results" class="search-results"></div>
            </div>
        
            <!-- Logo icone-->
            <a class ="nav-img-2" href="/"><img src="/img/mangahana-icon.png" alt="MangaHana-logo"></a>

            <!-- Options navbar -->
            <div class="nav-categories">
                <a href="/" class="flex-container">
                    <div class="bx-container"><i class='bx bxs-home'></i></div>
                    <div class="a-container">Acc<span class="green-text">ueil</span></div>
                </a>
                <a href="/catalogue" class="flex-container">
                    <div class="bx-container"><i class='bx bxs-bookmarks'></i></div>
                    <div class="a-container">Cata<span class="green-text">logue</span></div>
                </a>
                <a href="#" class="flex-container randomMangaLink">    
                    <div class="bx-container"><i class='bx bx-shuffle'></i></div>
                    <div class="a-container">Se lan<span class="green-text">cer</span></div>
                </a>
                <a href="/profil" class="flex-container">
                    <div class="bx-container"><i class='bx bx-street-view'></i></div>
                    <div class="a-container">Pro<span class="green-text">fil</span></div>
                </a>
            </div>

            <div class="decoration-line">
                <div class="left-line"></div>
                <div class="right-line"></div>
            </div>
        </nav>

        <!-- Slide Menu -->
        <div class="slidemenu">
            <div class="top-section">
                <button id="close-slidemenu"><i class='bx bx-x'></i></button>
                <a class="logoLink" href="/"><img class="nav-img" src="/img/mangahana-logo.png" alt="MangaHana-logo"></a>
                <div class="sep-section"></div>
            </div>

            <a href="/">
                <div class="options">
                    <i class='bx bxs-home'></i>
                    <p>Acc<span class="green">ueil</span></p>
                </div>
            </a>

            <a href="/catalogue">
                <div class="options">
                    <i class='bx bxs-bookmarks'></i>
                    <p>Cata<span class="green">logue</span></p>
                </div>
            </a>

            <a href="#" class="randomMangaLink">
                <div class="options">
                    <i class='bx bx-shuffle'></i>
                    <p>Se lan<span class="green">cer</span></p>
                </div>
            </a>

            <a href="/profil">
                <div class="options">
                    <i class='bx bx-street-view'></i>
                    <p>Pro<span class="green">fil</span></p>
                </div>
            </a>

            <p class="bottom">© 2024 MangaHana - Tous droits réservés.</p>
        </div>

        <button id="to-top-btn">
            <i class='bx bx-up-arrow-alt'></i>
        </button>


        <section class="bloc-scan">
            <div class="parameters">
                <div class="manga-info">
                    <h1 id="manga-title"></h1> 
                    <a id="manga-link" href="">En savoir plus sur <span id="manga-name-link"></span></a> <!-- Ids ajoutés ici -->
                </div>
                <div class="menus-options">
                    <!-- Mettre en plein écran -->
                    <button id="fullscreen-btn"><i class='bx bx-exit-fullscreen'></i></button>
                    <button id="lightmode-btn"><i class='bx bxs-moon'></i></button>
                </div>
                <div class="pages-option">
                    <!-- Bouton pour retourner au chapitre précédent -->
                    <button id="previous-chapter" class="chapter-btn">< Chapitre précédent</button>

                    <!-- Menu déroulant pour le choix du chapitre -->
                    <select class ="active" id="chapter-menu" name="chapter-menu"></select>

                    <select id="pages-menu"></select>

                    <!-- Choix de l'orientation de la lecture -->
                    <select class ="active" id="lecture-menu" name="lecture-menu">
                        <option value="verticale">Lecture verticale</option>
                        <option value="horizontale">Lecture horizontale</option>
                    </select>

                    <!-- Bouton pour passer au prochain chapitre -->
                    <button id="next-chapter" class="chapter-btn">Chapitre suivant ></i></button>

                    <!-- Bouton pour changer de page -->
                    <div id="flex-page-btn">
                        <button id="previous-page" class="page-btn">< Précédent</button>
                        <button id="next-page" class="page-btn">Suivant ></button>
                    </div>
                </div>
            </div>
            <div id="pages-flex" class="pages-flex-verticale">
                <div id="btn-over-img">
                    <button id="previous-on-img"></button>
                    <button id="next-on-img"></button>
                </div>

                <button id="go-down-on-img"></button>

                <div id="pages-container"></div>
            </div>

            <div class="parameters2">
                <div class="pages-option2">
                    <button id="previous-chapter2" class="chapter-btn">< Chapitre précédent</button>
                    <button id="next-chapter2" class="chapter-btn">Chapitre suivant ></i></button>
                </div>
            </div>
        </section>

        <script src="/script/script-fullscreen-btn.js"></script>

        <!-- Searchbar, slide-menu, to top btn -->
        <script>
            // SEARCHBAR de la NAVBAR
            document.addEventListener('DOMContentLoaded', () => {
                const searchInput = document.getElementById('search_text');
                const searchResults = document.getElementById('search-results');

                function handleSearchInput() {
                    const searchQuery = searchInput.value.toLowerCase();
                    searchResults.innerHTML = ''; 

                    if (searchQuery.length < 3) {
                        searchResults.style.display = 'none'; 
                        return;
                    }

                    fetch('/api/manga-data')
                        .then(response => response.json())
                        .then(data => {
                            const filteredResults = Object.keys(data).filter(key => 
                                data[key].Nom.toLowerCase().includes(searchQuery) ||
                                data[key].Alias.toLowerCase().includes(searchQuery)
                            );

                            if (filteredResults.length > 0) {
                                searchResults.style.display = 'flex'; 
                                
                                const maxResults = 6;
                                filteredResults.slice(0, maxResults).forEach((key, index) => {
                                    const manga = data[key];
                                    const resultItem = document.createElement('a');
                                    resultItem.href = `/${key}`; 
                                    resultItem.classList.add('search-result-item');

                                    const mangaDetails = document.createElement('div');
                                    mangaDetails.classList.add('manga-details');

                                    const mangaImage = document.createElement('img');
                                    mangaImage.src = `/img/couvertures/tome-${key}.avif`; 
                                    mangaImage.alt = `tome-${key}`; 
                                    mangaImage.classList.add('img');

                                    const mangaInfo = document.createElement('div');
                                    mangaInfo.classList.add('infos');
                                    const mangaName = document.createElement('p');
                                    mangaName.classList.add('bolder');
                                    mangaName.textContent = manga.Nom; 
                                    const mangaTags = document.createElement('p');
                                    mangaTags.classList.add('darker');
                                    const tags = manga.Tags;
                                    mangaTags.textContent = `Genres : ${tags}`; 

                                    mangaInfo.appendChild(mangaName);
                                    mangaInfo.appendChild(mangaTags);
                                    mangaDetails.appendChild(mangaImage);
                                    mangaDetails.appendChild(mangaInfo);

                                    resultItem.appendChild(mangaDetails);
                                    searchResults.appendChild(resultItem);

                                    if (index === filteredResults.slice(0, maxResults).length - 1) {
                                        resultItem.style.borderBottomLeftRadius = '8px';
                                        resultItem.style.borderBottomRightRadius = '8px';
                                    }
                                });
                            } else {
                                searchResults.style.display = 'none'; 
                            }
                        })
                        .catch(error => console.error('Erreur lors du chargement des données des mangas:', error));
                }

                searchInput.addEventListener('input', handleSearchInput);

                document.addEventListener('click', (event) => {
                    if (!searchInput.contains(event.target) && !searchResults.contains(event.target)) {
                        searchResults.style.display = 'none'; 
                    }
                });

                searchInput.addEventListener('focus', () => {
                    if (searchInput.value.length >= 3) {
                        searchResults.style.display = 'flex'; 
                    }
                });
            });

            document.addEventListener('DOMContentLoaded', () => {
                const searchInput = document.getElementById('search_text');
                const clearButton = document.getElementById('clear-button');

                function toggleClearButton() {
                    if (searchInput.value.length > 0) {
                        clearButton.style.display = 'block'; 
                    } else {
                        clearButton.style.display = 'none'; 
                    }
                }

                toggleClearButton();

                searchInput.addEventListener('input', toggleClearButton);

                clearButton.addEventListener('click', () => {
                    searchInput.value = ''; 
                    toggleClearButton(); 
                    searchInput.focus(); 
                });
            });

            window.onscroll = function() {
                const scrollPosition = window.scrollY || document.documentElement.scrollTop;
                const toTopButton = document.getElementById('to-top-btn');
                    
                const showAfter = 100;

                if (scrollPosition < showAfter) {
                    toTopButton.style.display = "none";
                } else {
                    toTopButton.style.display = "block";
                }
            };

            document.getElementById('to-top-btn').addEventListener('click', function() {
                window.scrollTo({
                top: 0, 
                behavior: 'smooth' 
                });
            });

            // SLIDE MENU
            const burgerButton = document.querySelector('.burger-menu-btn');
            const slideMenu = document.querySelector('.slidemenu');
            const closeSlidemenuBtn = document.getElementById('close-slidemenu');
            const overlay = document.createElement('div');

            overlay.classList.add('overlay');
            document.body.appendChild(overlay);

            burgerButton.addEventListener('click', () => {
                slideMenu.classList.toggle('open');  
                overlay.classList.toggle('active');  
            });

            overlay.addEventListener('click', () => {
                slideMenu.classList.remove('open');  
                overlay.classList.remove('active');  
            });

            closeSlidemenuBtn.addEventListener('click', () => {
                slideMenu.classList.remove('open');  
                overlay.classList.remove('active');  
            });

            // RANDOM MANGA
            fetch('/api/manga-data')
                .then(response => response.json())
                .then(data => {
                    // Liste des mangas
                    const mangaList = Object.keys(data).map(key => ({ name: data[key].Nom, url: `/${key}` }));

                    const randomMangaLinks = document.querySelectorAll('.randomMangaLink');

                    randomMangaLinks.forEach(link => {
                        link.addEventListener('click', function(event) {
                            event.preventDefault(); 
                            const randomIndex = Math.floor(Math.random() * mangaList.length); 
                            const selectedManga = mangaList[randomIndex]; 
                            window.location.href = selectedManga.url; 
                        });
                    });
                })
                .catch(error => console.error('Erreur lors du chargement des mangas:', error));

                
            // Service Worker
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () => {
                    navigator.serviceWorker.register("/service-worker.js")
                        .catch(error => {
                            console.log("Erreur d'enregistrement du Service Worker :", error);
                        });
                });
            }
        </script>

        <!-- Chargement des chapitres -->
        <script>
            // Fonction pour ajouter un chapitre au cookie
            function addChapterToHistory(chapterUrl) {
                const maxChapters = 10; // Limite de 30 chapitres stockés dans les cookies
                let history = getCookie('lastReadChapters'); 

                if (history) {
                    history = history.split(',');
                } else {
                    history = [];
                }

                if (!history.includes(chapterUrl)) {
                    history.push(chapterUrl);
                }

                if (history.length > maxChapters) {
                    history.shift(); 
                }

                document.cookie = `lastReadChapters=${history.join(',')}; path=/; max-age=31536000;`; // Cookie valide pour 1 an
            }

            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            function trackCurrentChapter() {
                const pathParts = window.location.pathname.split('/');
                const mangaName = pathParts[1]; 
                const chapter = pathParts[2]; 

                const chapterUrl = `${mangaName}/${chapter}`;

                addChapterToHistory(chapterUrl);
            }

            // Fonction pour ajouter un chapitre lu au local storage
            function addReadChapter(mangaName, chapterNumber) {
                const maxEntries = 500; 
                let readHistory = getReadHistory();

                if (!readHistory[mangaName]) {
                    readHistory[mangaName] = [];
                }

                if (!readHistory[mangaName].includes(chapterNumber)) {
                    readHistory[mangaName].push(chapterNumber);
                    readHistory[mangaName].sort((a, b) => a - b); 
                }

                reduceEntries(readHistory, maxEntries);
                saveReadHistory(readHistory);
            }

            // Fonction pour récupérer l'historique des chapitres lus depuis le local storage
            function getReadHistory() {
                const history = localStorage.getItem('read');
                return history ? JSON.parse(history) : {};
            }

            // Fonction pour sauvegarder l'historique des chapitres lus dans le local storage
            function saveReadHistory(readHistory) {
                localStorage.setItem('read', JSON.stringify(readHistory));
            }

            // Réduit les entrées totales si elles dépassent la limite
            function reduceEntries(readHistory, maxEntries) {
                let allEntries = [];

                // Collecte tous les chapitres sous forme de [{ manga, chapter, addedAt }]
                for (const manga in readHistory) {
                    allEntries.push(...readHistory[manga].map(chapter => ({ manga, chapter, addedAt: getAddedAt(manga, chapter) })));
                }

                allEntries.sort((a, b) => a.addedAt - b.addedAt);

                // Supprime les plus anciennes si on dépasse maxEntries
                while (allEntries.length > maxEntries) {
                    const oldest = allEntries.shift();
                    readHistory[oldest.manga] = readHistory[oldest.manga].filter(ch => ch !== oldest.chapter);
                    if (readHistory[oldest.manga].length === 0) {
                        delete readHistory[oldest.manga];
                    }
                }
            }

            // Fonction pour obtenir la date d'ajout d'un chapitre (ou maintenant s'il n'a pas encore été ajouté)
            function getAddedAt(manga, chapter) {
                const timestamps = JSON.parse(localStorage.getItem('readTimestamps') || '{}');
                return timestamps[`${manga}:${chapter}`] || Date.now();
            }

            // Fonction pour sauvegarder les dates d'ajout des chapitres
            function saveAddedAt(manga, chapter) {
                const timestamps = JSON.parse(localStorage.getItem('readTimestamps') || '{}');
                timestamps[`${manga}:${chapter}`] = Date.now();
                localStorage.setItem('readTimestamps', JSON.stringify(timestamps));
            }

            // Mise à jour automatique lors du changement de chapitre
            function trackReadChapter() {
                const pathParts = window.location.pathname.split('/');
                const mangaName = pathParts[1];
                const chapterNumber = pathParts[2];

                addReadChapter(mangaName, chapterNumber);
                saveAddedAt(mangaName, chapterNumber);
            }

            // Fonction pour charger les chapitres disponibles
            async function loadChapters(manga) {
                const response = await fetch(`/api/${manga}/chapters`);
                const chapters = await response.json();
        
                const chapterMenu = document.getElementById('chapter-menu');
                chapterMenu.innerHTML = ''; 
        
                chapters.forEach(chapter => {
                    const option = document.createElement('option');
                    option.value = chapter;
                    option.textContent = `Chapitre ${chapter}`;
                    chapterMenu.appendChild(option);
                });
        
                return chapters;
            }
        
            // Fonction pour mettre à jour l'état des boutons de chapitre
            function updateChapterButtons(chapters) {
                const currentChapter = parseInt(document.getElementById('chapter-menu').value);
        
                document.getElementById('previous-chapter').disabled = (currentChapter <= Math.min(...chapters));
                document.getElementById('next-chapter').disabled = (currentChapter >= Math.max(...chapters));
            }
        
            async function loadPages(manga, chapter) {
                const response = await fetch(`/api/${manga}/chapters/${chapter}/pages`);
                const pages = await response.json();

                const pagesContainer = document.getElementById('pages-container');
                pagesContainer.innerHTML = '';

                // Ajoute les pages dans l'élément pages-menu 
                const pagesMenu = document.getElementById('pages-menu');
                pagesMenu.innerHTML = ''; 

                pages.forEach((page, index) => {
                    const img = document.createElement('img');
                    img.src = `/scans/${manga}/${chapter}/${page}`; 
                    img.alt = `Page ${index + 1}`;
                    img.classList.add('lazy');
                    pagesContainer.appendChild(img);

                    const option = document.createElement('option');
                    option.value = page;
                    option.textContent = `Page ${index + 1}`;
                    pagesMenu.appendChild(option);
                });

                // Remplace les tirets par des espaces et capitalise chaque mot
                const formattedMangaName = manga
                    .replace(/-/g, ' ')  
                    .replace(/\b\w/g, char => char.toUpperCase()); 

                document.querySelector('.manga-info h1').innerHTML = `${formattedMangaName} : <span class="green">Chapitre ${chapter}</span>`;
                document.title = `${formattedMangaName} : Chapitre ${chapter} | Mangahana`;
            }

            window.onload = async function() {
                const pathParts = window.location.pathname.split('/');
                const mangaName = pathParts[1];  
                const chapterFromUrl = pathParts[2]; 
                
                const formattedMangaName = mangaName
                    .replace(/-/g, ' ')  
                    .replace(/\b\w/g, char => char.toUpperCase()); 

                document.getElementById('manga-title').innerHTML = `${formattedMangaName} : <span class="green">Chapitre ${chapterFromUrl}</span>`;
                document.getElementById('manga-name-link').innerHTML = `<span class="green">${formattedMangaName}</span>`;
                document.getElementById('manga-link').setAttribute('href', `/${mangaName}`); 

                // Mets à jour le titre de la page
                document.title = `${formattedMangaName} : Chapitre ${chapterFromUrl} | Mangahana`;

                // Charge les chapitres et le chapitre par défaut
                const chapters = await loadChapters(mangaName);  
                let defaultChapter = chapters.includes(chapterFromUrl) ? chapterFromUrl : chapters[0];

                // Charge les pages du chapitre par défaut ou celui trouvé dans l'URL
                await handleChapterChange(mangaName, defaultChapter);
                document.getElementById('chapter-menu').value = defaultChapter; 

                // Mets à jour les boutons de navigation
                updateChapterButtons(chapters);

                // Masque ou afficher le menu des pages en fonction du mode de lecture initial
                const lectureMenu = document.getElementById('lecture-menu');
                togglePagesMenuAndDisplay(lectureMenu.value, mangaName, defaultChapter);

                // Enregistrement des chapitres lus dans les cookies
                trackCurrentChapter(); 
                document.getElementById('chapter-menu').addEventListener('change', function() {
                    trackCurrentChapter(); 
                });
                document.getElementById('previous-chapter').addEventListener('click', function() {
                    trackCurrentChapter();
                });
                document.getElementById('next-chapter').addEventListener('click', function() {
                    trackCurrentChapter(); 
                });
                window.addEventListener('beforeunload', function() {
                    trackCurrentChapter(); 
                });

                trackReadChapter();
                document.getElementById('chapter-menu').addEventListener('change', function() {
                    trackReadChapter();
                });
                document.getElementById('previous-chapter').addEventListener('click', function() {
                    trackReadChapter();
                });
                document.getElementById('next-chapter').addEventListener('click', function() {
                    trackReadChapter();
                });
                window.addEventListener('beforeunload', function() {
                    trackReadChapter();
                });
            };

            async function togglePagesMenuAndDisplay(lectureMode, manga, chapter) {
                const pagesMenu = document.getElementById('pages-menu');
                const pageButtons = document.getElementById('flex-page-btn');  
                const btnOverImg = document.getElementById('btn-over-img');  
                const goDownOnImg = document.getElementById('go-down-on-img');  
                const previouschapterButton = document.getElementById('previous-chapter'); 
                const nextchapterButton = document.getElementById('next-chapter'); 
                const pagesFlex = document.getElementById('pages-flex'); 

                if (lectureMode === 'verticale') {
                    pagesMenu.style.display = 'none';  
                    pageButtons.style.display = 'none';
                    btnOverImg.style.display = 'none';
                    goDownOnImg.style.display = 'block';
                    previouschapterButton.classList.remove('hidden'); 
                    nextchapterButton.classList.remove('hidden'); 
                    pagesFlex.classList.remove('pages-flex-horizontale'); 
                    pagesFlex.classList.add('pages-flex-verticale'); 
                    await loadPages(manga, chapter);  
                } else {
                    pagesMenu.style.display = 'block'; 
                    pageButtons.style.display = 'flex'; 
                    btnOverImg.style.display = 'flex';
                    goDownOnImg.style.display = 'none';
                    previouschapterButton.classList.add('hidden'); 
                    nextchapterButton.classList.add('hidden'); 
                    pagesFlex.classList.remove('pages-flex-verticale'); 
                    pagesFlex.classList.add('pages-flex-horizontale'); 
                    await loadSinglePage(manga, chapter, 1);  
                }
            }

            // Gère le changement de type de lecture
            document.getElementById('lecture-menu').addEventListener('change', async function() {
                const selectedLectureMode = this.value;
                const mangaFromUrl = window.location.pathname.split('/')[1]; 
                const selectedChapter = document.getElementById('chapter-menu').value;

                await togglePagesMenuAndDisplay(selectedLectureMode, mangaFromUrl, selectedChapter);
            });

            // Fonction pour charger une seule page (lecture non-verticale)
            async function loadSinglePage(manga, chapter, pageNumber) {
            const response = await fetch(`/api/${manga}/chapters/${chapter}`);
            const pages = await response.json();

            const pagesContainer = document.getElementById('pages-container');
            pagesContainer.innerHTML = ''; 

            const page = pages[pageNumber - 1];
            if (page) {
                const img = document.createElement('img');
                img.src = `/scans/${manga}/${chapter}/${page}`; 
                img.alt = `Page ${page}`;
                img.loading = "lazy"; 
                pagesContainer.appendChild(img);
                
                // Vérifie si c'est la première page
                if (pageNumber === 1) {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    img.onload = function() {
                        img.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    };
                }
            }

            // Mets à jour le menu des pages
            const pagesMenu = document.getElementById('pages-menu');
            pagesMenu.innerHTML = ''; 

            pages.forEach((page, index) => {
                const option = document.createElement('option');
                option.value = index + 1; 
                option.textContent = `Page ${index + 1}`;
                pagesMenu.appendChild(option);
            });

            // Sélectionne la page actuelle dans le menu
            pagesMenu.value = pageNumber;
        }



            // Événement lors du changement de page dans le menu des pages
            document.getElementById('pages-menu').addEventListener('change', async function() {
                const selectedPage = this.value;
                const mangaFromUrl = window.location.pathname.split('/')[1]; 
                const selectedChapter = document.getElementById('chapter-menu').value;

                await loadSinglePage(mangaFromUrl, selectedChapter, selectedPage);
            });

            // Événement lors du changement de chapitre via le chapter-menu
            document.getElementById('chapter-menu').addEventListener('change', async function() {
                const selectedChapter = this.value;
                const mangaFromUrl = window.location.pathname.split('/')[1];
                await handleChapterChange(mangaFromUrl, selectedChapter);
            });

            // Gére le changement de chapitre
            async function handleChapterChange(manga, chapter) {
                await loadPages(manga, chapter);
                const lectureMode = document.getElementById('lecture-menu').value;

                // Gére l'affichage en fonction du mode de lecture
                if (lectureMode === 'verticale') {
                    await loadPages(manga, chapter);
                } else {
                    await loadSinglePage(manga, chapter, 1);
                }

                // Mets à jour l'URL pour refléter le chapitre sélectionné
                window.history.pushState({}, '', `/${manga}/${chapter}`);
            }

            // Gére les boutons précédent et suivant
            document.getElementById('previous-chapter').addEventListener('click', async function() {
                const currentChapter = parseInt(document.getElementById('chapter-menu').value);
                const mangaFromUrl = window.location.pathname.split('/')[1]; 
                const chapters = await fetch(`/api/${mangaFromUrl}/chapters`).then(res => res.json());

                if (currentChapter > 1) {
                    const newChapter = currentChapter - 1;
                    document.getElementById('chapter-menu').value = newChapter; 
                    await handleChapterChange(mangaFromUrl, newChapter);
                }

                updateChapterButtons(chapters);
            });

            document.getElementById('next-chapter').addEventListener('click', async function() {
                const currentChapter = parseInt(document.getElementById('chapter-menu').value);
                const mangaFromUrl = window.location.pathname.split('/')[1]; 
                const chapters = await fetch(`/api/${mangaFromUrl}/chapters`).then(res => res.json());

                if (currentChapter < Math.max(...chapters)) {
                    const newChapter = currentChapter + 1;
                    document.getElementById('chapter-menu').value = newChapter; 
                    await handleChapterChange(mangaFromUrl, newChapter);
                }

                updateChapterButtons(chapters);
            });

            // Gére les boutons précédent et suivant
            document.getElementById('previous-chapter2').addEventListener('click', async function() {
                const currentChapter = parseInt(document.getElementById('chapter-menu').value);
                const mangaFromUrl = window.location.pathname.split('/')[1]; 
                const chapters = await fetch(`/api/${mangaFromUrl}/chapters`).then(res => res.json());

                if (currentChapter > 1) {
                    const newChapter = currentChapter - 1;
                    document.getElementById('chapter-menu').value = newChapter; 
                    await handleChapterChange(mangaFromUrl, newChapter);
                }

                updateChapterButtons(chapters);

                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            document.getElementById('next-chapter2').addEventListener('click', async function() {
                const currentChapter = parseInt(document.getElementById('chapter-menu').value);
                const mangaFromUrl = window.location.pathname.split('/')[1]; 
                const chapters = await fetch(`/api/${mangaFromUrl}/chapters`).then(res => res.json());

                if (currentChapter < Math.max(...chapters)) {
                    const newChapter = currentChapter + 1;
                    document.getElementById('chapter-menu').value = newChapter; 
                    await handleChapterChange(mangaFromUrl, newChapter);
                }

                updateChapterButtons(chapters);

                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // Fonction pour gérer la navigation de page
            async function handlePageNavigation(direction) {
                const mangaFromUrl = window.location.pathname.split('/')[1]; 
                const selectedChapter = document.getElementById('chapter-menu').value;
                const pagesMenu = document.getElementById('pages-menu');

                const currentPage = parseInt(pagesMenu.value); 
                const totalPages = pagesMenu.options.length; 
                let newPage = currentPage;

                // Détermine la nouvelle page
                if (direction === 'previous') {
                    if (currentPage > 1) {
                        newPage = currentPage - 1;
                    } else {
                        // Si on est à la première page, passer au chapitre précédent
                        const currentChapter = parseInt(selectedChapter);
                        const chapters = await fetch(`/api/${mangaFromUrl}/chapters`).then(res => res.json());
                        if (currentChapter > Math.min(...chapters)) {
                            const newChapter = currentChapter - 1; 
                            document.getElementById('chapter-menu').value = newChapter;
                            await handleChapterChange(mangaFromUrl, newChapter); 
                        }
                        return; 
                    }
                } else if (direction === 'next') {
                    if (currentPage < totalPages) {
                        newPage = currentPage + 1; 
                    } else {
                        // Si on est à la dernière page, passer au chapitre suivant
                        const currentChapter = parseInt(selectedChapter);
                        const chapters = await fetch(`/api/${mangaFromUrl}/chapters`).then(res => res.json());
                        if (currentChapter < Math.max(...chapters)) {
                            const newChapter = currentChapter + 1; 
                            document.getElementById('chapter-menu').value = newChapter; 
                            await handleChapterChange(mangaFromUrl, newChapter); 
                        }
                        return; 
                    }
                }

                // Mets à jour la sélection du menu et charger la nouvelle page
                pagesMenu.value = newPage; 
                await loadSinglePage(mangaFromUrl, selectedChapter, newPage); 
            }

            // Événement pour le bouton précédent de page
            document.getElementById('previous-page').addEventListener('click', () => handlePageNavigation('previous'));

            // Événement pour le bouton suivant de page
            document.getElementById('next-page').addEventListener('click', () => handlePageNavigation('next'));

            document.getElementById('previous-on-img').addEventListener('click', () => handlePageNavigation('previous'));
            document.getElementById('next-on-img').addEventListener('click', () => handlePageNavigation('next'));

            document.getElementById('go-down-on-img').addEventListener('click', () => {
                window.scrollBy({ top: 300, behavior: 'smooth' }); // Défilement vers le bas (100px)
            });

        </script>

        <!-- Flèches du clavier -->
        <script>
            let isKeyPressed = false; 

            // Événement pour gérer les touches fléchées gauche et droite
            window.addEventListener('keydown', async function(event) {
                if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
                    event.preventDefault(); // Empêche le comportement par défaut uniquement pour les flèches
                }

                // Vérifie si une touche est déjà pressée
                if (isKeyPressed) return;

                const lectureMode = document.getElementById('lecture-menu').value;
                isKeyPressed = true; 

                if (lectureMode === 'verticale') {
                    if (event.key === 'ArrowRight') {
                        document.getElementById('next-chapter').click(); // Simule un clic sur le bouton suivant pour changer de chapitre
                    } else if (event.key === 'ArrowLeft'){
                        document.getElementById('previous-chapter').click(); 
                    }
                } else if (lectureMode === 'horizontale') {
                    if (event.key === 'ArrowRight') {
                        document.getElementById('next-page').click();
                    } else if (event.key === 'ArrowLeft'){
                        document.getElementById('previous-page').click();
                    }
                }

                // Délai pour réinitialiser le drapeau après un court instant
                setTimeout(() => {
                    isKeyPressed = false; // Réinitialisation le drapeau après 200 ms
                }, 200);
            });
        </script>

        <!-- Bouton plein écran -->
        <script>
            document.getElementById("fullscreen-btn").addEventListener("click", function() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            });
        </script>

        <!-- Cookies dark mode -->
        <script>
            // Fonction pour appliquer le thème stocké dans les cookies
            function applyStoredTheme() {
                const theme = getCookie('theme');
                
                if (theme === 'dark' || theme === '') {
                    // Si pas de cookie ou si le cookie est "dark", on applique le mode sombre
                    document.body.classList.remove('light-mode');
                    document.getElementById('lightmode-btn').innerHTML = "<i class='bx bxs-moon'></i>";
                } else {
                    // Si le cookie est "light", on applique le mode clair
                    document.body.classList.add('light-mode');
                    document.getElementById('lightmode-btn').innerHTML = "<i class='bx bxs-sun'></i>";
                }
            }
        
            // Fonction pour basculer entre le mode sombre et clair
            function toggleDarkMode() {
                const body = document.body;
                
                if (body.classList.contains('light-mode')) {
                    // Activer le mode sombre
                    body.classList.remove('light-mode');
                    document.getElementById('lightmode-btn').innerHTML = "<i class='bx bxs-moon'></i>";
                    setCookie('theme', 'dark', 365);
                } else {
                    // Activer le mode clair
                    body.classList.add('light-mode');
                    document.getElementById('lightmode-btn').innerHTML = "<i class='bx bxs-sun'></i>";
                    setCookie('theme', 'light', 365);
                }
            }
        
            // Fonction pour définir un cookie
            function setCookie(name, value, days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                const expires = "expires=" + date.toUTCString();
                document.cookie = name + "=" + value + ";" + expires + ";path=/";
            }
        
            // Fonction pour récupérer un cookie
            function getCookie(name) {
                const cookieName = name + "=";
                const decodedCookie = decodeURIComponent(document.cookie);
                const cookieArray = decodedCookie.split(';');
                for (let i = 0; i < cookieArray.length; i++) {
                    let cookie = cookieArray[i];
                    while (cookie.charAt(0) === ' ') {
                        cookie = cookie.substring(1);
                    }
                    if (cookie.indexOf(cookieName) === 0) {
                        return cookie.substring(cookieName.length, cookie.length);
                    }
                }
                return "";
            }
        
            // Applique le thème au chargement de la page
            document.addEventListener('DOMContentLoaded', applyStoredTheme);
        
            // Gère l'événement click sur le bouton darkmode
            document.getElementById('lightmode-btn').addEventListener('click', toggleDarkMode);
        </script>
        
        
        <footer>
            <div class="decoration-line">
                <div class="left-line"></div>
                <div class="right-line"></div>
            </div>

            <div class="flexbox">
                <div class="flex-container">
                    <a href="/">Accueil</a>
                    <div class="footer-line"></div>
                    <a href="/about-us">À propos de nous</a>
                    <div class="footer-line"></div>
                    <a href="/privacy-policy">Privacy Policy</a>
                    <div class="footer-line"></div>
                    <a href="/dmca">DMCA</a>
                </div>
                <p>©MangaHana - Tous droits réservés.</p>
            </div>

        </footer>
</body>
</html>