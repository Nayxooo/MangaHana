<!DOCTYPE html>
<html lang="fr">
    <head>
        <title>Catalogue | Mangahana</title> 
        <meta charset="UTF-8">
        <meta name="description" content="MangaHana - Lecture de scans">
        <meta name="keywords" content="mangahana, scan, vf, sans pubs, free">
        <link rel="canonical" href="https://mangahana.fr/">
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        <link rel="shortcut icon" type="image/png" href="img/mangahana-icon.png">
        <link rel="shortcut icon" sizes="192x192" href="img/mangahana-icon.png">
        <link rel="apple-touch-icon" href="img/mangahana-icon.png">
        <link rel="manifest" href="manifest.json">
        <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
        <link rel="stylesheet" href="styles/style.css">
        <link rel="stylesheet" href="styles/navbar-footer.css">
        <link rel="stylesheet" href="styles/style-catalogue.css">
        <link rel="stylesheet" href="styles/resp-catalogue.css">    
    </head>

    <body>
        <!-- Navbar -->
        <nav>

            <!-- Burger button -->
            <div class="burger-menu">
                <button class="burger-menu-btn">
                    <div class="burger-line"></div>
                    <div class="burger-line"></div>
                    <div class="burger-line"></div>
                </button>
            </div>

            <!-- Logo -->
            <a class="nav-img" href="/"><img src="img/mangahana-logo.png" alt="MangaHana-logo"></a>
            
            <!-- Barre de recherche -->
            <div class="nav-searchbar">
                <div class="flexbox">
                    <i class='bx bx-search'></i>
                    <input name="search_text" id="search_text" type="search" class="search-input" placeholder="Rechercher..." autocomplete="off">
                    <button type="button" class="clear-button" id="clear-button">
                        <img src="img/cursors/cross.avif" alt="Clear search" class="clear-icon">
                    </button>
                </div>
                <!-- Résultats de recherche -->
                <div id="search-results" class="search-results"></div>
            </div>
        
            <!-- Logo icone-->
            <a class ="nav-img-2" href="/"><img src="img/mangahana-icon.png" alt="MangaHana-logo"></a>

            <!-- Options navbar -->
            <div class="nav-categories">
                <a href="/" class="flex-container">
                    <div class="bx-container"><i class='bx bxs-home'></i></div>
                    <div class="a-container">Acc<span class="green-text">ueil</span></div>
                </a>
                <a href="/catalogue" class="flex-container">
                    <div class="bx-container"><i class='bx bxs-bookmarks'></i></div>
                    <div class="a-container">Cata<span class="green-text">logue</span></div>
                </a>
                <a href="#" class="flex-container randomMangaLink">    
                    <div class="bx-container"><i class='bx bx-shuffle'></i></div>
                    <div class="a-container">Se lan<span class="green-text">cer</span></div>
                </a>
                <a href="/profil" class="flex-container">
                    <div class="bx-container"><i class='bx bx-street-view'></i></div>
                    <div class="a-container">Pro<span class="green-text">fil</span></div>
                </a>
            </div>

            <div class="decoration-line">
                <div class="left-line"></div>
                <div class="right-line"></div>
            </div>
        </nav>

        <!-- Slide Menu -->
        <div class="slidemenu">
            <div class="top-section">
                <button id="close-slidemenu"><i class='bx bx-x'></i></button>
                <a class="logoLink" href="/"><img class="nav-img" src="img/mangahana-logo.png" alt="MangaHana-logo"></a>
                <div class="sep-section"></div>
            </div>

            <a href="/">
                <div class="options">
                    <i class='bx bxs-home'></i>
                    <p>Acc<span class="green">ueil</span></p>
                </div>
            </a>

            <a href="/catalogue">
                <div class="options">
                    <i class='bx bxs-bookmarks'></i>
                    <p>Cata<span class="green">logue</span></p>
                </div>
            </a>

            <a href="#" class="randomMangaLink">
                <div class="options">
                    <i class='bx bx-shuffle'></i>
                    <p>Se lan<span class="green">cer</span></p>
                </div>
            </a>

            <a href="/profil">
                <div class="options">
                    <i class='bx bx-street-view'></i>
                    <p>Pro<span class="green">fil</span></p>
                </div>
            </a>

            <p class="bottom">© 2024 MangaHana - Tous droits réservés.</p>
        </div>

        <button id="to-top-btn">
            <i class='bx bx-up-arrow-alt'></i>
        </button>

        <section class="bloc-entier">
            <div class="catalogue-title">
                <i class='bx bxs-bookmarks'></i>
                <h1>Cata<span class="green">logue</span></h1>
            </div>

            <div class="mainflex">
                <button class="show-filters">Afficher les filtres</button>

                <div class="filters">
                    <div class="filter-searchbar">
                        <div class="flexbox">
                            <input name="searched_text" id="searched_text" type="search" class="search-input" placeholder="Rechercher..." autocomplete="off">
                        </div>
                    </div>

                    <div class="filter-title">
                        <h1>Genres</h1>
                    </div>
                    <div class="filter-tags">
                        <div class="tag-checkbox">
                            <div class="checkbox" data-tag="Action"></div>
                            <p>Action</p>
                        </div>
                        <div class="tag-checkbox">
                            <div class="checkbox" data-tag="Aventure"></div>
                            <p>Aventure</p>
                        </div>
                        <div class="tag-checkbox">
                            <div class="checkbox" data-tag="Comédie"></div>
                            <p>Comédie</p>
                        </div>
                        <div class="tag-checkbox">
                            <div class="checkbox" data-tag="Drame"></div>
                            <p>Drame</p>
                        </div>
                        <div class="tag-checkbox">
                            <div class="checkbox" data-tag="Ecchi"></div>
                            <p>Ecchi</p>
                        </div>
                        <div class="tag-checkbox">
                            <div class="checkbox" data-tag="Fantaisie"></div>
                            <p>Fantaisie</p>
                        </div>
                        <div class="tag-checkbox">
                            <div class="checkbox" data-tag="Horreur"></div>
                            <p>Horreur</p>
                        </div>
                        <div class="tag-checkbox">
                            <div class="checkbox" data-tag="Mystère"></div>
                            <p>Mystère</p>
                        </div>
                        <div class="tag-checkbox">
                            <div class="checkbox" data-tag="Romance"></div>
                            <p>Romance</p>
                        </div>
                        <div class="tag-checkbox">
                            <div class="checkbox" data-tag="Science-fiction"></div>
                            <p>Science-Fiction</p>
                        </div>
                        <div class="tag-checkbox">
                            <div class="checkbox" data-tag="Slice of Life"></div>
                            <p>Slice of Life</p>
                        </div>
                        <div class="tag-checkbox">
                            <div class="checkbox" data-tag="Sports"></div>
                            <p>Sports</p>
                        </div>
                        <div class="tag-checkbox">
                            <div class="checkbox" data-tag="Suspense"></div>
                            <p>Suspense</p>
                        </div>
                    </div>

                    <div class="filter-title">
                        <h1>Filtrer par lettre</h1>
                    </div>
                    <div class="filter-letters">
                        <button id="a">A</button>
                        <button id="b">B</button>
                        <button id="c">C</button>
                        <button id="d">D</button>
                        <button id="e">E</button>
                        <button id="f">F</button>
                        <button id="g">G</button>
                        <button id="h">H</button>
                        <button id="i">I</button>
                        <button id="j">J</button>
                        <button id="k">K</button>
                        <button id="l">L</button>
                        <button id="m">M</button>
                        <button id="n">N</button>
                        <button id="o">O</button>
                        <button id="p">P</button>
                        <button id="q">Q</button>
                        <button id="r">R</button>
                        <button id="s">S</button>
                        <button id="t">T</button>
                        <button id="u">U</button>
                        <button id="v">V</button>
                        <button id="w">W</button>
                        <button id="x">X</button>
                        <button id="y">Y</button>
                        <button id="z">Z</button>
                        <!-- <span class="letter" data-letter="A">A</span>
                        <span class="letter" data-letter="B">B</span>
                        <span class="letter" data-letter="C">C</span> -->
                    </div>

                    <button id="reset-filters">Réinitialiser les filtres</button>

                    <button id="apply-filters" class="search-btn">
                        <div class="i-ctn">
                            <i class='bx bx-search'></i>
                        </div>
                        Appliquer les filtres
                    </button>
                </div>

                <div class="catalogue-flex">
                    <div class="mangas-flex"></div>
                    <div class="pagination">
                        <button class="prev-btn inactive"><i class='bx bx-left-arrow-circle'></i></button>
                        <button class="next-btn"><i class='bx bx-right-arrow-circle'></i></button>
                    </div>
                </div>
            </div>
        </section>

        <script src="script/script-main.js"></script>

        <!-- Gestion des filtres et affichage mangas -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const searchedInput = document.getElementById('searched_text');
                let allMangas = {};
                let activeLetter = ''; 
                let currentPage = 1; 

                let mangasPerPage;

                const smallScreen = window.matchMedia('(max-width: 790px)');
                const normalScreen = window.matchMedia('(min-width: 791px) and (max-width: 8000px)');

                function checkScreenSize() {
                    if (smallScreen.matches) {
                        mangasPerPage = 27;
                    } else if (normalScreen.matches) {
                        mangasPerPage = 28;
                    }
                }

                checkScreenSize();
                smallScreen.addEventListener('change', checkScreenSize);
                normalScreen.addEventListener('change', checkScreenSize);
        
                fetch('/api/manga-data')
                    .then(response => response.json())
                    .then(mangas => {
                        allMangas = mangas;
                        afficherMangas(allMangas); 
                    })
        
                function filtrerMangasParTags(mangas, selectedTags, excludedTags) {
                    const filteredMangas = {};
                    Object.keys(mangas).forEach(mangaKey => {
                        const manga = mangas[mangaKey];
        
                        const mangaTags = manga.Tags.split(',').map(tag => tag.trim());
        
                        const hasSelectedTags = selectedTags.length === 0 || selectedTags.every(tag => mangaTags.includes(tag));
                        const hasExcludedTags = excludedTags.length > 0 && excludedTags.some(tag => mangaTags.includes(tag));
        
                        if (hasSelectedTags && !hasExcludedTags) {
                            filteredMangas[mangaKey] = manga;
                        }
                    });
                    return filteredMangas;
                }
        
                function filtrerMangas(query) {
                    const filteredMangas = {};
                    Object.keys(allMangas).forEach(mangaKey => {
                        const manga = allMangas[mangaKey];
                        if (manga.Nom && manga.Alias && manga.Tags) {
                            if (manga.Nom.toLowerCase().includes(query) || manga.Alias.toLowerCase().includes(query)) {
                                filteredMangas[mangaKey] = manga;
                            }
                        }
                    });
                    return filteredMangas;
                }
        
                function trierMangas(mangas) {
                    return Object.keys(mangas)
                        .map(mangaKey => ({
                            key: mangaKey,
                            ...mangas[mangaKey]
                        }))
                        .sort((a, b) => a.Nom.localeCompare(b.Nom));
                }
        
                // Fonction pour afficher les mangas en tenant compte de la pagination
                function afficherMangas(mangas) {
                    const mangaFlex = document.querySelector('.mangas-flex');
                    mangaFlex.innerHTML = ''; 
        
                    if (Object.keys(mangas).length === 0) {
                        mangaFlex.innerHTML = '<div class="no-result">Aucun résultat trouvé.</div>';
                        return; 
                    }
        
                    const sortedMangas = trierMangas(mangas);
                    const totalPages = Math.ceil(sortedMangas.length / mangasPerPage);
                    const startIndex = (currentPage - 1) * mangasPerPage;
                    const endIndex = Math.min(startIndex + mangasPerPage, sortedMangas.length);
                    const mangasToDisplay = sortedMangas.slice(startIndex, endIndex);
        
                    mangasToDisplay.forEach(manga => {
                        fetch(`/api/${manga.key}/last-chapter`)
                            .then(response => response.json())
                            .then(data => {
                                const lastChapter = data.dernierChapitre ? `Chapitre ${data.dernierChapitre}` : 'Bientôt disponible';
                                const numChap = data.dernierChapitre ? `${data.dernierChapitre}` : 'null';
        
                                const mangaHTML = `
                                    <div class="content" data-manga-key="${manga.key}">
                                        <a href="/${manga.key}" class="img-container">
                                            <img src="img/couvertures/tome-${manga.key}.avif" alt="tome-${manga.Nom}">
                                        </a>
                                        <div class="infos">
                                            <a href="/${manga.key}">${manga.Nom}</a>
                                            <a class="chap-link" href="/${manga.key}/${numChap}">${lastChapter}</a>
                                        </div>
                                    </div>
                                `;
        
                                mangaFlex.insertAdjacentHTML('beforeend', mangaHTML);
                            })
                            .catch(error => console.error('Erreur lors de la récupération du dernier chapitre:', error));
                    });
        
                    updatePagination(totalPages);
                }
        
                // Met à jour la pagination
                function updatePagination(totalPages) {
                    const prevButton = document.querySelector('.prev-btn');
                    const nextButton = document.querySelector('.next-btn');
        
                    prevButton.classList.toggle('inactive', currentPage === 1);
                    nextButton.classList.toggle('inactive', currentPage === totalPages);
                }
        
                // Fonction de debounce
                function debounce(func, delay) {
                    let timeoutId;
                    return function(...args) {
                        if (timeoutId) {
                            clearTimeout(timeoutId);
                        }
                        timeoutId = setTimeout(() => {
                            func.apply(null, args);
                        }, delay);
                    };
                }
        
                // Écouter l'événement 'input' pour la recherche avec debounce
                searchedInput.addEventListener('input', debounce(() => {
                    const query = searchedInput.value.trim().toLowerCase();
                    currentPage = 1; 
                    if (query.length >= 3) {
                        const resultatsFiltres = filtrerMangas(query);
                        afficherMangas(resultatsFiltres); 
                    } else {
                        afficherMangas(allMangas); 
                    }
                }, 700)); 
        
                const checkboxes = document.querySelectorAll('.checkbox');
                const applyFiltersButton = document.getElementById('apply-filters');
                const resetFiltersButton = document.getElementById('reset-filters');
                
                const letterButtons = document.querySelectorAll('.filter-letters button');
        
                letterButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        letterButtons.forEach(btn => btn.classList.remove('active-letter'));
                        letterButtons.forEach(btn => btn.classList.add('non-active'));
        
                        // Activer la lettre cliquée
                        button.classList.add('active-letter');
                        activeLetter = button.textContent; 
                    });
                });
        
                applyFiltersButton.addEventListener('click', () => {
                    const selectedTags = [];
                    const excludedTags = [];
        
                    checkboxes.forEach(checkbox => {
                        const tag = checkbox.getAttribute('data-tag');
                        const state = checkbox.classList.contains('check') ? 'check' : (checkbox.classList.contains('cross') ? 'cross' : 'neutral');
        
                        if (state === 'check') {
                            selectedTags.push(tag);
                        } else if (state === 'cross') {
                            excludedTags.push(tag);
                        }
                    });
        
                    const query = searchedInput.value.trim().toLowerCase();
                    currentPage = 1; 
                    const filteredBySearch = query.length >= 3 ? filtrerMangas(query) : allMangas;
                    const filteredByTags = filtrerMangasParTags(filteredBySearch, selectedTags, excludedTags);
                    const filteredByLetter = filterMangasByLetter(filteredByTags, activeLetter); 
        
                    afficherMangas(filteredByLetter);
                });
        
                function filterMangasByLetter(mangas, letter) {
                    const filteredMangas = {};
                    Object.keys(mangas).forEach(mangaKey => {
                        const manga = mangas[mangaKey];
                        if (manga.Nom && manga.Nom.startsWith(letter)) {
                            filteredMangas[mangaKey] = manga;
                        }
                    });
                    return filteredMangas;
                }
        
                resetFiltersButton.addEventListener('click', () => {
                    searchedInput.value = ''; 
                    
                    checkboxes.forEach(checkbox => {
                        checkbox.classList.remove('check', 'cross');
                        checkbox.classList.add('neutral');
                    });
                    
                    letterButtons.forEach(button => {
                        button.classList.remove('active-letter');
                        button.classList.add('non-active');
                    });
                    activeLetter = ''; 
                    
                    currentPage = 1; 
                    afficherMangas(allMangas); 
                });
        
                // Init des checkboxes
                checkboxes.forEach(checkbox => {
                    let state = 0; // 0: neutral, 1: cross, 2: check
        
                    function updateCheckbox() {
                        checkbox.classList.remove('neutral', 'cross', 'check');
                        if (state === 0) {
                            checkbox.classList.add('neutral');
                        } else if (state === 1) {
                            checkbox.classList.add('cross');
                        } else if (state === 2) {
                            checkbox.classList.add('check');
                        }
                    }
        
                    checkbox.addEventListener('click', () => {
                        state = (state + 1) % 3; 
                        updateCheckbox();
                    });
        
                    updateCheckbox();
                });
        
                // Gestion de la pagination
                const prevButton = document.querySelector('.prev-btn');
                const nextButton = document.querySelector('.next-btn');
                function scrollToTop() {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }

                prevButton.addEventListener('click', scrollToTop);
                nextButton.addEventListener('click', scrollToTop);
        
                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        const query = searchedInput.value.trim().toLowerCase();
                        const filteredBySearch = query.length >= 3 ? filtrerMangas(query) : allMangas;
                        const selectedTags = [];
                        const excludedTags = [];
        
                        checkboxes.forEach(checkbox => {
                            const tag = checkbox.getAttribute('data-tag');
                            const state = checkbox.classList.contains('check') ? 'check' : (checkbox.classList.contains('cross') ? 'cross' : 'neutral');
        
                            if (state === 'check') {
                                selectedTags.push(tag);
                            } else if (state === 'cross') {
                                excludedTags.push(tag);
                            }
                        });
        
                        const filteredByTags = filtrerMangasParTags(filteredBySearch, selectedTags, excludedTags);
                        const filteredByLetter = filterMangasByLetter(filteredByTags, activeLetter);
        
                        afficherMangas(filteredByLetter);
                    }
                });
        
                nextButton.addEventListener('click', () => {
                    const query = searchedInput.value.trim().toLowerCase();
                    const filteredBySearch = query.length >= 3 ? filtrerMangas(query) : allMangas;
                    const selectedTags = [];
                    const excludedTags = [];
        
                    checkboxes.forEach(checkbox => {
                        const tag = checkbox.getAttribute('data-tag');
                        const state = checkbox.classList.contains('check') ? 'check' : (checkbox.classList.contains('cross') ? 'cross' : 'neutral');
        
                        if (state === 'check') {
                            selectedTags.push(tag);
                        } else if (state === 'cross') {
                            excludedTags.push(tag);
                        }
                    });
        
                    const filteredByTags = filtrerMangasParTags(filteredBySearch, selectedTags, excludedTags);
                    const filteredByLetter = filterMangasByLetter(filteredByTags, activeLetter);
                    const totalPages = Math.ceil(Object.keys(filteredByLetter).length / mangasPerPage);
        
                    if (currentPage < totalPages) {
                        currentPage++;
                        afficherMangas(filteredByLetter);
                    }
                });
            });
        </script>
        
        <!-- Affichage des filtres pour téléphone -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const filters = document.querySelector('.filters');
                const showFiltersBtn = document.querySelector('.show-filters');

                showFiltersBtn.addEventListener('click', () => {
                    if (!filters.classList.contains('show') && !filters.classList.contains('hide')) {
                        filters.classList.add('show');
                    } else if (filters.classList.contains('show')) {
                        filters.classList.remove('show');
                        filters.classList.add('hide');
                    } else if (filters.classList.contains('hide')) {
                        filters.classList.remove('hide');
                        filters.classList.add('show');
                    }

                    showFiltersBtn.classList.toggle('active');

                    if (showFiltersBtn.classList.contains('active')) {
                        showFiltersBtn.textContent = 'Cacher les filtres';
                    } else {
                        showFiltersBtn.textContent = 'Afficher les filtres';
                    }
                });
            });
        </script>

        <footer>
            <div class="decoration-line">
                <div class="left-line"></div>
                <div class="right-line"></div>
            </div>

            <div class="flexbox">
                <div class="flex-container">
                    <a href="/">Accueil</a>
                    <div class="footer-line"></div>
                    <a href="/about-us">À propos de nous</a>
                    <div class="footer-line"></div>
                    <a href="/privacy-policy">Privacy Policy</a>
                    <div class="footer-line"></div>
                    <a href="/dmca">DMCA</a>
                </div>
                <p>©MangaHana - Tous droits réservés.</p>
            </div>

        </footer>
    </body>
</html>